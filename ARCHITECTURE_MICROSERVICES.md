# Предложение по переходу на микросервисы с постоянным хранением

Цель: сохранить данные при обновлениях релизов и разделить зоны ответственности (граф доменов, планирование инициатив, работа с сотрудниками), сохранив их связность через API. В качестве постоянного хранилища используется PostgreSQL (отдельные базы или схемы на усмотрение команды).

## Сервисы

### 1. Graph Service
- **Зона ответственности:** домены, модули, артефакты, связи между ними, экспорт/импорт графов, публикация снапшотов.
- **Хранилище:** PostgreSQL. Таблицы `graphs`, `domains`, `modules`, `artifacts`, `relations` (для рёбер), `layouts` (координаты). Версионирование снапшотов — таблица `snapshots` с JSONB для layout и метаданных.
- **API (REST):**
  - `POST /graphs` — создание графа (+опционально копирование существующего).
  - `GET /graphs` — список графов.
  - `GET /graphs/{id}` — текущий снимок.
  - `PUT /graphs/{id}` — сохранение снимка/макета.
  - `DELETE /graphs/{id}` — удаление не-дефолтного графа.
  - `GET /graphs/{id}/snapshots` — история версий.
- **Интеграция:** отдаёт стабильные идентификаторы узлов (domain/module/artifact) для использования другими сервисами. Срабатывает webhook/событие `graph.published` при новом снапшоте.

### 2. Initiative Planning Service
- **Зона ответственности:** инициативы и проекты, дорожные карты, бюджет/приоритеты, статусы.
- **Хранилище:** PostgreSQL. Таблицы `initiatives`, `milestones`, `links_to_graph` (многие-ко-многим: инициатива ↔ узлы графа с типом узла), `risks`.
- **API (REST):**
  - `POST /initiatives` — создать инициативу, указав ссылки на узлы графа (`{ nodeId, nodeType }`).
  - `GET /initiatives?graphId=...` — выборка инициатив, связанных с конкретным графом или узлом.
  - `GET /initiatives/{id}` — карточка инициативы с планом и рисками.
  - `PATCH /initiatives/{id}` — обновить статус, приоритет, связи с графом.
  - `POST /initiatives/{id}/milestones` — добавить веху.
- **Интеграция:** читает узлы Graph Service по их ID (через BFF) и валидирует существование. Подписывается на события `graph.published` для пересчёта ссылок и рисков при изменении структуры.

### 3. Workforce/Experts Service
- **Зона ответственности:** сотрудники/эксперты, навыки, загрузка, привязка к инициативам.
- **Хранилище:** PostgreSQL. Таблицы `employees`, `skills`, `employee_skills`, `assignments` (сотрудник ↔ инициатива), `availability`.
- **API (REST):**
  - `POST /employees`, `GET /employees`, `GET /employees/{id}` — CRUD сотрудников.
  - `PATCH /employees/{id}/skills` — обновление компетенций.
  - `POST /assignments` — назначение на инициативу с ролями и долей загрузки.
  - `GET /assignments?initiativeId=...` — получение состава команды.
- **Интеграция:** хранит только ссылки на `initiativeId`; для отображения связанного домена или модуля UI обращается к BFF, который агрегирует данные Graph и Initiative.

### 4. Identity/Auth Service (общий)
- **Зона ответственности:** пользователи, роли, выдача JWT/refresh, аудит логинов.
- **Хранилище:** PostgreSQL. Таблицы `users`, `roles`, `permissions`, `login_audit`.
- **API (REST):** `POST /login`, `POST /refresh`, `GET /users` (админ), `POST /users`, `PATCH /users/{id}`, `DELETE /users/{id}`.
- **Интеграция:** выдает JWT, в клеймах — `sub` и `role`. Остальные сервисы валидируют токен через общую библиотеку или JWKS. Аудит логинов остаётся здесь и может получать события от BFF для централизованного журнала.

### 5. API Gateway / BFF
- **Назначение:** единая точка для фронтенда; оркеструет вызовы Graph, Initiative, Workforce и Auth, применяет CORS, rate limiting, кэш справочников.
- **Маршруты:**
  - `/api/login`, `/api/users/*` → Auth.
  - `/api/graphs/*` → Graph.
  - `/api/initiatives/*` → Initiative (плюс агрегат `GET /api/initiatives/{id}` собирает карточку инициативы из трёх сервисов).
  - `/api/employees/*`, `/api/assignments/*` → Workforce.
  - **Связность:** обеспечивает кросс-ссылки без прямых зависимостей между сервисами. Например, `GET /api/initiatives/{id}` возвращает вложенный список связанных узлов и назначенных сотрудников, собирая данные из трёх сервисов.
  - **Кэширование и периметр:** gateway поддерживает настраиваемые CORS/rate limiting через переменные окружения и кэширует справочники Graph/Workforce (TTL регулируется `GRAPH_CACHE_TTL_MS`, `WORKFORCE_CACHE_TTL_MS`).

## Потоки данных и связность
- **Стабильные идентификаторы:** Graph Service генерирует неизменяемый `nodeId` для каждого узла. Initiative Planning хранит только эти ID и тип узла; Workforce знает только `initiativeId`.
- **События:** Graph Service публикует событие `graph.published`; Initiative Service может валидировать связи и уведомлять Workforce об изменениях состава инициатив.
- **Миграции:** при деплое каждый сервис применяет свои миграции (например, `knex migrate:latest` или `prisma migrate deploy`), что сохраняет данные между релизами.
- **Резервирование/бэкапы:** использовать dump или снапшоты PostgreSQL по каждой базе/схеме; для dev окружения можно держать docker-compose с volume и init-скриптами.

## Этапы внедрения
1. **Подготовить PostgreSQL**: создать отдельные схемы или базы и настроить миграции.
2. **Выделить Graph Service**: перенести работу с `graphStore` в Express-сервис с PostgreSQL и сохранить существующие REST-контракты.
3. **Добавить Initiative Service**: вынести инициативы из графа, оставить ссылки на `nodeId` из Graph Service.
4. **Добавить Workforce Service**: перенести экспертов/сотрудников, завести связи `initiativeId`.
5. **Ввести Auth Service и BFF**: фронтенд продолжает ходить на `/api/*`, BFF маршрутизирует запросы и добавляет агрегацию данных.
6. **Настроить CI/CD**: миграции в каждом сервисе + healthcheck `/health`. Каталоги данных Postgres монтируются в volumes, что сохраняет состояние между релизами.

## Проверка полноты изменений
- **Данные сохраняются между релизами:** все сервисы используют PostgreSQL со своими миграциями и stateful volumes.
- **Разделение контуров:** Graph, Initiative, Workforce и Auth являются самостоятельными сервисами с отдельными схемами данных.
- **Связность через API/события:** BFF проксирует `/api/*`, граф публикует `graph.published`, Initiative валидирует `nodeId`, Workforce опирается на `initiativeId`.
- **Совместимость фронтенда:** контракты REST `/graphs`, `/initiatives`, `/employees`/`assignments`, `/login`/`users` сохранены через шлюз.
- **Наблюдаемость и готовность:** во всех сервисах предусмотрен `/health` и аудит логинов/событий, что позволяет автоматизировать проверки перед релизом.
